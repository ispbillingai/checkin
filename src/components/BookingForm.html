<!-- Minimal booking form with no console logs -->
<div class="booking-form">
  <form id="bookingForm">
    <!-- Room selection -->
    <label for="room">Select Room</label>
    <select id="room" name="room" required>
      <option value="">Select a room</option>
      <!-- (Rooms will be populated, if needed) -->
    </select>
    
    <!-- Entry points -->
    <label>Select Entry Points</label>
    <div id="entryPointsCheckboxes">
      <p>Loading entry points...</p>
    </div>
    
    <!-- PIN position -->
    <label for="pinPosition">PIN Position</label>
    <select id="pinPosition" name="pinPosition" required>
      <option value="" disabled selected>Select a position</option>
      <option value="1">Position 1</option>
      <option value="2">Position 2</option>
      <!-- ... etc ... -->
    </select>
    
    <!-- PIN code -->
    <label for="pinCode">PIN Code</label>
    <input id="pinCode" name="pinCode" type="text" pattern="[0-9]{4,6}" placeholder="4-6 digits" />
    <button type="button" id="generatePinButton">Generate</button>
    
    <!-- Arrival/Departure -->
    <label for="arrivalDateTime">Arrival Date & Time</label>
    <input id="arrivalDateTime" name="arrivalDateTime" type="datetime-local" required />
    
    <label for="departureDateTime">Departure Date & Time</label>
    <input id="departureDateTime" name="departureDateTime" type="datetime-local" required />
    
    <!-- Name/Email/Phone -->
    <label for="name">Full Name</label>
    <input id="name" name="name" type="text" required />
    
    <label for="email">Email</label>
    <input id="email" name="email" type="email" required />
    
    <label for="phone">Phone</label>
    <input id="phone" name="phone" type="tel" required />
    
    <button type="submit" id="submitButton">Create Booking</button>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Optionally initialize date inputs
  initializeDateInputs();

  // Load entry points immediately
  loadAllEntryPoints();

  // Generate PIN code on click
  const generatePinButton = document.getElementById('generatePinButton');
  if (generatePinButton) {
    generatePinButton.addEventListener('click', function() {
      const pinCode = Math.floor(1000 + Math.random() * 9000).toString();
      document.getElementById('pinCode').value = pinCode;
    });
  }

  // Handle form submission
  const bookingForm = document.getElementById('bookingForm');
  if (bookingForm) {
    bookingForm.addEventListener('submit', function(e) {
      e.preventDefault();

      // Validate selected entry points
      const selectedEntryPoints = [];
      document.querySelectorAll('input[name="entryPoints[]"]:checked').forEach(function(checkbox) {
        selectedEntryPoints.push(checkbox.value);
      });
      if (selectedEntryPoints.length === 0) {
        alert('Please select at least one entry point.');
        return;
      }

      // Build FormData
      const formData = new FormData(bookingForm);
      // Replace entryPoints[] in FormData with a JSON array
      document.querySelectorAll('input[name="entryPoints[]"]').forEach(function(i){ 
        formData.delete('entryPoints[]'); 
      });
      formData.append('entryPoints', JSON.stringify(selectedEntryPoints));

      // Basic PIN checks
      const pinCode = formData.get('pinCode') || '';
      if (!/^\d{4,6}$/.test(pinCode)) {
        alert('PIN code must be 4–6 digits.');
        return;
      }

      // (POST to your booking processor)
      const submitButton = document.getElementById('submitButton');
      submitButton.disabled = true;
      submitButton.textContent = 'Processing...';

      fetch('/api/process_booking.php', { method: 'POST', body: formData })
        .then(function(r){ return r.json(); })
        .then(function(data){
          submitButton.disabled = false;
          submitButton.textContent = 'Create Booking';
          if (data.success) {
            alert('Booking created! Access code: ' + data.data.accessCode);
            bookingForm.reset();
            initializeDateInputs();
            // Reload entry points or set them to default if needed
          } else {
            alert('Error: ' + (data.message || 'Could not create booking'));
          }
        })
        .catch(function(){
          submitButton.disabled = false;
          submitButton.textContent = 'Create Booking';
          alert('Network or server error occurred.');
        });
    });
  }

  function loadAllEntryPoints() {
    const entryPointsContainer = document.getElementById('entryPointsCheckboxes');
    if (!entryPointsContainer) return;

    entryPointsContainer.innerHTML = '<p>Loading entry points...</p>';

    // Adjust this path if your file is actually at /src/api/get_entry_points.php
    fetch('/api/get_entry_points.php')
      .then(function(r){ return r.json(); })
      .then(function(data){
        if (data.success && Array.isArray(data.entry_points) && data.entry_points.length > 0) {
          entryPointsContainer.innerHTML = '';
          data.entry_points.forEach(function(entry){
            const div = document.createElement('div');
            div.className = 'entry-point-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'entryPoints[]';
            checkbox.value = entry.id;

            const label = document.createElement('label');
            label.textContent = entry.name + ' – ' + (entry.description || 'No description');

            div.appendChild(checkbox);
            div.appendChild(label);
            entryPointsContainer.appendChild(div);
          });
        } else {
          // If no data or an error, fallback to "demo" entry points:
          createDemoEntryPoints();
        }
      })
      .catch(function(){
        createDemoEntryPoints();
      });
  }

  function createDemoEntryPoints() {
    const entryPointsContainer = document.getElementById('entryPointsCheckboxes');
    if (!entryPointsContainer) return;
    entryPointsContainer.innerHTML = '';

    const demo = [
      { id: 'entry1', name: 'Main Entrance', description: 'Front door at the lobby' },
      { id: 'entry2', name: 'Side Entrance', description: 'Entrance near parking lot' },
      { id: 'entry3', name: 'Back Entrance', description: 'Entrance near the garden' }
    ];

    demo.forEach(function(entry){
      const div = document.createElement('div');
      div.className = 'entry-point-item';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.name = 'entryPoints[]';
      checkbox.value = entry.id;

      const label = document.createElement('label');
      label.textContent = entry.name + ' – ' + (entry.description || 'No description');

      div.appendChild(checkbox);
      div.appendChild(label);
      entryPointsContainer.appendChild(div);
    });
  }

  function initializeDateInputs() {
    const now = new Date();
    const plusOneDay = new Date(now);
    plusOneDay.setDate(plusOneDay.getDate() + 1);

    function formatInputDate(d) {
      return d.toISOString().slice(0, 16); // "YYYY-MM-DDTHH:MM"
    }

    const arrival = document.getElementById('arrivalDateTime');
    const departure = document.getElementById('departureDateTime');
    if (!arrival || !departure) return;

    arrival.min = formatInputDate(now);
    departure.min = formatInputDate(plusOneDay);
    arrival.value = formatInputDate(now);
    departure.value = formatInputDate(plusOneDay);
  }
});
</script>
